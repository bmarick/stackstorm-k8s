---
suite: Secret files
templates:
  # primary template files
  - secrets_st2auth.yaml

tests:
  - it: ST2 Auth Secret include by default
    template: secrets_st2auth.yaml
    set:
      st2: {}
    release:
      name: st2ha
    asserts:
      - hasDocuments:
          count: 1
      - isNotEmpty:
          path: data.ST2_AUTH_PASSWORD
        documentIndex: 0
      - equal:
          path: data.ST2_AUTH_USERNAME
          value: c3QyYWRtaW4=
        documentIndex: 0

  - it: ST2 Auth Secret set custom username and password
    template: secrets_st2auth.yaml
    set:
      st2:
        username: example
        password: badPassword
    release:
      name: st2ha
    asserts:
      - hasDocuments:
          count: 1
      - equal:
          path: data.ST2_AUTH_USERNAME
          value: "ZXhhbXBsZQ==" # Base64 encoded value
        documentIndex: 0
      - equal:
          path: data.ST2_AUTH_PASSWORD
          value: "YmFkUGFzc3dvcmQ="  # Base64 encoded value
        documentIndex: 0

  - it: ST2 Auth Secret disable generation
    template: secrets_st2auth.yaml
    set:
      st2:
        disable_generate_st2_auth_secret: true
    release:
      name: st2ha
    asserts:
      - hasDocuments:
          count: 0
